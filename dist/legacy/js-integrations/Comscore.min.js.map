{"version":3,"file":"Comscore.min.js","sources":["../../../src/utils/logUtil.js","../../../src/integrations/Comscore/constants.js","../../../src/utils/constants.js","../../../src/utils/ScriptLoader.js","../../../src/integrations/Comscore/browser.js"],"sourcesContent":["const LOG_LEVEL_INFO = 1;\nconst LOG_LEVEL_DEBUG = 2;\nconst LOG_LEVEL_WARN = 3;\nconst LOG_LEVEL_ERROR = 4;\nconst DEF_LOG_LEVEL = LOG_LEVEL_ERROR;\nlet LOG_LEVEL = DEF_LOG_LEVEL;\n\nconst logger = {\n  setLogLevel(logLevel) {\n    switch (logLevel.toUpperCase()) {\n      case 'INFO':\n        LOG_LEVEL = LOG_LEVEL_INFO;\n        break;\n      case 'DEBUG':\n        LOG_LEVEL = LOG_LEVEL_DEBUG;\n        break;\n      case 'WARN':\n        LOG_LEVEL = LOG_LEVEL_WARN;\n        break;\n      default:\n        LOG_LEVEL = DEF_LOG_LEVEL;\n        break;\n    }\n  },\n\n  info(...args) {\n    if (LOG_LEVEL <= LOG_LEVEL_INFO) {\n      console.info(...args);\n    }\n  },\n\n  debug(...args) {\n    if (LOG_LEVEL <= LOG_LEVEL_DEBUG) {\n      console.log(...args);\n    }\n  },\n\n  warn(...args) {\n    if (LOG_LEVEL <= LOG_LEVEL_WARN) {\n      console.warn(...args);\n    }\n  },\n\n  error(...args) {\n    if (LOG_LEVEL <= LOG_LEVEL_ERROR) {\n      console.error(...args);\n    }\n  },\n};\n\nexport default logger;\n","const NAME = 'COMSCORE';\nconst CNameMapping = {\n  [NAME]: NAME,\n  Comscore: NAME,\n  'Com Score': NAME,\n  'com Score': NAME,\n  'com score': NAME,\n  'Com score': NAME,\n};\n\nexport { NAME, CNameMapping };\n","// Reserved Keywords for properties/traits\nconst RESERVED_KEYS = [\n  'anonymous_id',\n  'id',\n  'sent_at',\n  'received_at',\n  'timestamp',\n  'original_timestamp',\n  'event_text',\n  'event',\n];\n\nconst CONFIG_URL =\n  'https://api.rudderlabs.com/sourceConfig/?p=__MODULE_TYPE__&v=__PACKAGE_VERSION__';\nconst SDK_CDN_BASE_URL = 'https://cdn.rudderlabs.com';\nconst CDN_ARCH_VERSION_DIR = 'v1.1';\nconst CDN_INT_DIR = 'js-integrations';\nconst DEST_SDK_BASE_URL = `${SDK_CDN_BASE_URL}/${CDN_ARCH_VERSION_DIR}/${CDN_INT_DIR}`;\n\nconst MAX_WAIT_FOR_INTEGRATION_LOAD = 10000;\nconst INTEGRATION_LOAD_CHECK_INTERVAL = 1000;\nconst INTG_SUFFIX = '_RS';\nconst POLYFILL_URL =\n  'https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.find%2CArray.prototype.includes%2CPromise%2CString.prototype.endsWith%2CString.prototype.includes%2CString.prototype.startsWith%2CObject.entries%2CObject.values%2CElement.prototype.dataset%2CString.prototype.replaceAll';\n\nconst GENERIC_TRUE_VALUES = ['true', 'True', 'TRUE', 't', 'T', '1'];\nconst GENERIC_FALSE_VALUES = ['false', 'False', 'FALSE', 'f', 'F', '0'];\n\nconst SAMESITE_COOKIE_OPTS = ['Lax', 'None', 'Strict'];\n\nconst DEFAULT_SESSION_TIMEOUT = 30 * 60 * 1000; // 30 min in milliseconds\nconst MIN_SESSION_TIMEOUT = 10 * 1000; // 10 sec in milliseconds\nconst MIN_SESSION_ID_LENGTH = 10;\n\nconst ERROR_REPORTING_SERVICE_GLOBAL_KEY_NAME = 'errorReporting';\nconst LOAD_ORIGIN = 'RS_JS_SDK';\n\nconst DEFAULT_REGION = 'US';\nconst DEFAULT_DATAPLANE_URL = 'https://hosted.rudderlabs.com';\n\nconst RESIDENCY_SERVERS = [DEFAULT_REGION, 'EU'];\n\nconst SUPPORTED_CONSENT_MANAGERS = ['oneTrust'];\n\nconst SYSTEM_KEYWORDS = ['library', 'consentManagement'];\nconst UA_CH_LEVELS = ['none', 'default', 'full'];\n\nexport {\n  RESERVED_KEYS,\n  CONFIG_URL,\n  SDK_CDN_BASE_URL,\n  CDN_ARCH_VERSION_DIR,\n  CDN_INT_DIR,\n  DEST_SDK_BASE_URL,\n  MAX_WAIT_FOR_INTEGRATION_LOAD,\n  INTEGRATION_LOAD_CHECK_INTERVAL,\n  INTG_SUFFIX,\n  POLYFILL_URL,\n  GENERIC_TRUE_VALUES,\n  GENERIC_FALSE_VALUES,\n  SAMESITE_COOKIE_OPTS,\n  DEFAULT_SESSION_TIMEOUT,\n  MIN_SESSION_TIMEOUT,\n  MIN_SESSION_ID_LENGTH,\n  ERROR_REPORTING_SERVICE_GLOBAL_KEY_NAME,\n  LOAD_ORIGIN,\n  DEFAULT_REGION,\n  DEFAULT_DATAPLANE_URL,\n  RESIDENCY_SERVERS,\n  SUPPORTED_CONSENT_MANAGERS,\n  SYSTEM_KEYWORDS,\n  UA_CH_LEVELS,\n};\n","/* eslint-disable no-use-before-define */\n// import logger from \"../utils/logUtil\";\n\nimport { handleError } from \"./errorHandler\";\n\nconst defaultAsyncState = true;\n\nexport const LOAD_ORIGIN = 'RS_JS_SDK';\n/**\n * Script loader\n * @param {String} id                               Id of the script\n * @param {String} src                              URL of the script\n * @param {Object} options                          Object containing different configuration\n * @param {Boolean} options.async                   Determines script will be loaded asynchronously or not\n * @param {Boolean} options.isNonNativeSDK          Determines whether the script that will be loaded is one of RS's own\n * @param {Boolean} options.skipDatasetAttributes   Determines whether to add or skip dataset attribute\n */\nconst ScriptLoader = (id, src, options = {}) => {\n  try {\n    const exists = document.getElementById(id);\n    if (exists) {\n      // logger.debug(\"script already loaded\");\n      return;\n    }\n\n    const js = document.createElement('script');\n    js.src = src;\n    js.async = options.async === undefined ? defaultAsyncState : options.async;\n    js.type = 'text/javascript';\n    js.id = id;\n    // This checking is in place to skip the dataset attribute for some cases(while loading polyfill)\n    if (options.skipDatasetAttributes !== true) {\n      js.setAttribute('data-loader', LOAD_ORIGIN);\n      if (options.isNonNativeSDK !== undefined) {\n        js.setAttribute('data-isNonNativeSDK', options.isNonNativeSDK);\n      }\n    }\n    const headElmColl = document.getElementsByTagName('head');\n    if (headElmColl.length > 0) {\n      // logger.debug(\"==adding script==\", js);\n      headElmColl[0].insertBefore(js, headElmColl[0].firstChild);\n    } else {\n      const e = document.getElementsByTagName('script')[0];\n      // logger.debug(\"==parent script==\", e);\n      // logger.debug(\"==adding script==\", js);\n      e.parentNode.insertBefore(js, e);\n    }\n  } catch (e) {\n    handleError(e);\n  }\n};\n\nexport default ScriptLoader;\n","/* eslint-disable class-methods-use-this */\nimport logger from '../../utils/logUtil';\nimport {\n  MAX_WAIT_FOR_INTEGRATION_LOAD,\n  INTEGRATION_LOAD_CHECK_INTERVAL,\n} from '../../utils/constants';\nimport { NAME } from './constants';\nimport { LOAD_ORIGIN } from '../../utils/ScriptLoader';\n\nclass Comscore {\n  constructor(config, analytics, destinationInfo) {\n    if (analytics.logLevel) {\n      logger.setLogLevel(analytics.logLevel);\n    }\n    this.c2ID = config.c2ID;\n    this.analytics = analytics;\n    this.comScoreBeaconParam = config.comScoreBeaconParam ? config.comScoreBeaconParam : {};\n    this.isFirstPageCallMade = false;\n    this.failed = false;\n    this.comScoreParams = {};\n    this.replayEvents = [];\n    this.name = NAME;\n    this.areTransformationsConnected = destinationInfo && destinationInfo.areTransformationsConnected;\n    this.destinationId = destinationInfo && destinationInfo.destinationId;\n  }\n\n  init() {\n    logger.debug('===in init Comscore init===');\n  }\n\n  identify(rudderElement) {\n    logger.debug('in Comscore identify');\n  }\n\n  track(rudderElement) {\n    logger.debug('in Comscore track');\n  }\n\n  page(rudderElement) {\n    logger.debug('in Comscore page');\n\n    this.loadConfig(rudderElement);\n\n    if (!this.isFirstPageCallMade) {\n      this.isFirstPageCallMade = true;\n      this.initAfterPage();\n    } else {\n      if (this.failed) {\n        this.replayEvents = [];\n        return;\n      }\n      if (!this.isLoaded() && !this.failed) {\n        this.replayEvents.push(['page', rudderElement]);\n        return;\n      }\n      const { properties } = rudderElement.message;\n      // window.COMSCORE.beacon({c1:\"2\", c2: \"\"});\n      // this.comScoreParams = this.mapComscoreParams(properties);\n      window.COMSCORE.beacon(this.comScoreParams);\n    }\n  }\n\n  loadConfig(rudderElement) {\n    logger.debug('=====in loadConfig=====');\n    this.comScoreParams = this.mapComscoreParams(rudderElement.message.properties);\n    window._comscore = window._comscore || [];\n    window._comscore.push(this.comScoreParams);\n  }\n\n  initAfterPage() {\n    logger.debug('=====in initAfterPage=====');\n    (function () {\n      const s = document.createElement('script');\n      const el = document.getElementsByTagName('script')[0];\n      s.async = true;\n      s.setAttribute('data-loader', LOAD_ORIGIN);\n      s.src = `${\n        document.location.protocol == 'https:' ? 'https://sb' : 'http://b'\n      }.scorecardresearch.com/beacon.js`;\n      el.parentNode.insertBefore(s, el);\n    })();\n\n    this._isReady(this).then((instance) => {\n      instance.replayEvents.forEach((event) => {\n        instance[event[0]](event[1]);\n      });\n    });\n  }\n\n  pause(time) {\n    return new Promise((resolve) => {\n      setTimeout(resolve, time);\n    });\n  }\n\n  _isReady(instance, time = 0) {\n    return new Promise((resolve) => {\n      if (this.isLoaded()) {\n        this.failed = false;\n        instance.analytics.emit('ready');\n        return resolve(instance);\n      }\n      if (time >= MAX_WAIT_FOR_INTEGRATION_LOAD) {\n        this.failed = true;\n        return resolve(instance);\n      }\n      this.pause(INTEGRATION_LOAD_CHECK_INTERVAL).then(() => {\n        return this._isReady(instance, time + INTEGRATION_LOAD_CHECK_INTERVAL).then(resolve);\n      });\n    });\n  }\n\n  mapComscoreParams(properties) {\n    logger.debug('=====in mapComscoreParams=====');\n    const comScoreBeaconParamsMap = this.comScoreBeaconParam;\n\n    const comScoreParams = {};\n\n    Object.keys(comScoreBeaconParamsMap).forEach(function (property) {\n      if (property in properties) {\n        const key = comScoreBeaconParamsMap[property];\n        const value = properties[property];\n        comScoreParams[key] = value;\n      }\n    });\n\n    comScoreParams.c1 = '2';\n    comScoreParams.c2 = this.c2ID;\n    /* if (this.options.comscorekw.length) {\n      comScoreParams.comscorekw = this.options.comscorekw;\n    } */\n    logger.debug('=====in mapComscoreParams=====', comScoreParams);\n    return comScoreParams;\n  }\n\n  isLoaded() {\n    logger.debug('in Comscore isLoaded');\n    if (!this.isFirstPageCallMade) {\n      return true;\n    }\n    return !!window.COMSCORE;\n  }\n\n  isReady() {\n    return !!window.COMSCORE;\n  }\n}\n\nexport { Comscore };\n"],"names":["_CNameMapping","LOG_LEVEL","logger","logLevel","toUpperCase","_console2","console","log","apply","arguments","INTEGRATION_LOAD_CHECK_INTERVAL","NAME","_defineProperty","Comscore","config","analytics","destinationInfo","_classCallCheck","this","c2ID","comScoreBeaconParam","isFirstPageCallMade","failed","comScoreParams","replayEvents","name","areTransformationsConnected","destinationId","key","value","rudderElement","loadConfig","isLoaded","push","message","properties","window","COMSCORE","beacon","initAfterPage","mapComscoreParams","_comscore","s","el","document","createElement","getElementsByTagName","async","setAttribute","src","concat","location","protocol","parentNode","insertBefore","_isReady","then","instance","forEach","event","time","Promise","resolve","setTimeout","_this","length","undefined","emit","pause","comScoreBeaconParamsMap","Object","keys","property","c1","c2"],"mappings":"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"}